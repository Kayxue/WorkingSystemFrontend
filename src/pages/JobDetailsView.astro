---
// JobDetails.astro
import Layout from '../layouts/Layout.astro';
import JobDetailsView from '../components/JobDetailsView.solid.tsx';

function validateGigId(id: string | undefined): string | null {
  if (!id || id === '[object Object]' || typeof id !== 'string') {
    console.error('Invalid gigId detected:', {
      gigId: id,
      type: typeof id,
      url: Astro.url.href,
      referer: Astro.request.headers.get('referer')
    });
    return null;
  }

  const idPattern = /^[a-zA-Z0-9_-]+$/;
  if (!idPattern.test(id)) {
    console.error('gigId format invalid:', id);
    return null;
  }

  return id;
}

const validatedGigId = validateGigId(Astro.params.gigId);

// Early return for invalid IDs
if (!validatedGigId) {
  const errorMessage = Astro.params.gigId ? `Invalid job ID format: "${Astro.params.gigId}"` : 'Invalid job ID';

  return new Response(`
    <html>
      <head><title>Invalid Job ID</title></head>
      <body style="font-family: system-ui, sans-serif; padding: 2rem; text-align: center;">
        <h1>Invalid Job ID</h1>
        <p>${errorMessage}</p>
        <p><strong>Debug Info:</strong></p>
        <p>URL: ${Astro.url.href}</p>
        <p>Referer: ${Astro.request.headers.get('referer') || 'None'}</p>
        <p>Please check the URL and try again.</p>
        <button onclick="window.location.href='/dashboard'" style="background: #007acc; color: white; border: none; padding: 1rem 2rem; border-radius: 4px; cursor: pointer; font-size: 1rem;">‚Üê Back to dashboard</button>
      </body>
    </html>
  `, {
    status: 400,
    headers: { 'Content-Type': 'text/html' }
  });
}

const pageTitle = `Job Details | WorkNow`;

// Optional: Add server-side data fetching if needed
// const jobData = await fetchJobData(validatedGigId).catch(() => null);
---

<Layout title={pageTitle}>
  <main class="job-details-page">
    <JobDetailsView 
      client:only="solid" 
      gigId={validatedGigId} 
      
    />
  </main>
</Layout>

<style>
  .job-details-page {
    min-height: 100vh;
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Remove default padding/margins from the layout */
  :global(body) {
    margin: 0;
    padding: 0;
    font-family: system-ui, sans-serif;
  }

  /* Ensure the job details container takes full width */
  :global(.jobDetailsContainer) {
    width: 100%;
  }
</style>