---
// src/pages/job/[gigId]/index.astro
import Layout from '../layouts/Layout.astro';
import JobLayout from '../components/job/JobLayout.solid.tsx';

function validateGigId(id: string | undefined): string | null {
  if (!id || id === '[object Object]' || typeof id !== 'string') {
    console.error('Invalid gigId detected:', {
      gigId: id,
      type: typeof id,
      url: Astro.url.href,
      referer: Astro.request.headers.get('referer')
    });
    return null;
  }

  const idPattern = /^[a-zA-Z0-9_-]+$/;
  if (!idPattern.test(id)) {
    console.error('gigId format invalid:', id);
    return null;
  }

  return id;
}

const validatedGigId = validateGigId(Astro.params.gigId);

// Early return for invalid IDs
if (!validatedGigId) {
  const errorMessage = Astro.params.gigId ? `Invalid job ID format: "${Astro.params.gigId}"` : 'Invalid job ID';

  return new Response(`
    <html>
      <head><title>Invalid Job ID</title></head>
      <body style="font-family: system-ui, sans-serif; padding: 2rem; text-align: center;">
        <h1>Invalid Job ID</h1>
        <p>${errorMessage}</p>
        <p><strong>Debug Info:</strong></p>
        <p>URL: ${Astro.url.href}</p>
        <p>Referer: ${Astro.request.headers.get('referer') || 'None'}</p>
        <p>Please check the URL and try again.</p>
        <button onclick="window.location.href='/dashboard'" style="background: #007acc; color: white; border: none; padding: 1rem 2rem; border-radius: 4px; cursor: pointer; font-size: 1rem;">‚Üê Back to dashboard</button>
      </body>
    </html>
  `, {
    status: 400,
    headers: { 'Content-Type': 'text/html' }
  });
}

const pageTitle = `Job Management | WorkNow`;
---

<Layout title={pageTitle}>
  <JobLayout 
    client:only="solid" 
    gigId={validatedGigId}
  />
</Layout>

<style>
  /* Ensure full height layout */
  :global(body) {
    margin: 0;
    padding: 0;
    font-family: system-ui, sans-serif;
  }

  /* Make sure the layout container takes full viewport height */
  :global(.jobLayoutContainer) {
    min-height: 100vh;
  }

  /* Prevent layout shift when sidebar collapses */
  :global(.mainContent) {
    transition: margin-left 0.3s ease;
  }

  /* Mobile-specific overrides */
  @media (max-width: 768px) {
    :global(.sidebar) {
      position: fixed;
      z-index: 1000;
    }
    :global(.mobileOverlay) {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
  }
</style>