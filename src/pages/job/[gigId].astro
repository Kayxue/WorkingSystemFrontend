---
import Layout from '../../layouts/Layout.astro';
import JobLayout from '../../components/job/JobLayout.solid.tsx';
const { gigId } = Astro.params;
const section = Astro.url.searchParams.get('section') || 'details';
const status = Astro.url.searchParams.get('status') || 'all';


function validateGigId(id: string | undefined): string | null {
  if (!id || id === '[object Object]' || typeof id !== 'string') {
    console.error('Invalid gigId detected:', {
      gigId: id,
      type: typeof id,
      url: Astro.url.href,
      referer: Astro.request.headers.get('referer')
    });
    return null;
  }

  const idPattern = /^[a-zA-Z0-9_-]+$/;
  if (!idPattern.test(id)) {
    console.error('gigId format invalid:', id);
    return null;
  }

  return id;
}

const validatedGigId = validateGigId(gigId);

// Early return for invalid IDs
if (!validatedGigId) {
  const errorMessage = gigId ? `Invalid job ID format: "${gigId}"` : 'Invalid job ID';

  return new Response(`
    <html>
      <head><title>Invalid Job ID</title></head>
      <body style="font-family: system-ui, sans-serif; padding: 2rem; text-align: center;">
        <h1>Invalid Job ID</h1>
        <p>${errorMessage}</p>
        <p><strong>Debug Info:</strong></p>
        <p>URL: ${Astro.url.href}</p>
        <p>Referer: ${Astro.request.headers.get('referer') || 'None'}</p>
        <p>Please check the URL and try again.</p>
        <button onclick="window.location.href='/dashboard'" style="background: #007acc; color: white; border: none; padding: 1rem 2rem; border-radius: 4px; cursor: pointer; font-size: 1rem;">← Back to dashboard</button>
      </body>
    </html>
  `, {
    status: 400,
    headers: { 'Content-Type': 'text/html' }
  });
}

const pageTitle = `Job Management | WorkNow`;
---

<Layout title={pageTitle}>
  <main class="job-management-page">
    <!-- ✅ Load the new JobLayout component with sidebar navigation -->
    <JobLayout client:only="solid" gigId={validatedGigId} initialSection={section} initialStatus={status} />
  </main>
</Layout>

<style>
  .job-management-page {
    height: 100vh;
    overflow: hidden;
    padding-top: 4rem;
  }

  /* Remove default padding/margins from the layout when using full-height sidebar */
  :global(body) {
    margin: 0;
    padding: 0;
  }
</style>